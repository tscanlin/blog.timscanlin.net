{"head":{"title":"Automated Deploys With Travis","layout":"Post","date":"2016-10-28T00:00:00.000Z","description":"Using Travis CI is a great way to automate repetitive tasks like building and testing your projects. But recently I've been using it toâ€¦"},"body":"<p>Using <a href=\"https://travis-ci.org/\">Travis CI</a> is a great way to automate repetitive tasks like building and testing your projects. But recently I've been using it to automate deployments to github pages and it's been great. I have read a <a href=\"https://medium.com/@nthgergo/publishing-gh-pages-with-travis-ci-53a8270e87db#.2mit50e96\">few</a> <a href=\"https://gist.github.com/domenic/ec8b0fc8ab45f39403dd\">tutorials</a> <a href=\"http://www.steveklabnik.com/automatically_update_github_pages_with_travis_example/\">that</a> outlined similar steps, but they didn't quite have the results I wanted so I decided to write my own. To automate deploying to github pages with <a href=\"https://travis-ci.org/\">Travis</a>, here's the steps I followed:</p>\n<ol>\n<li>\n<p><a href=\"https://github.com/settings/tokens\">Get a personal access token from github.com</a> Note: You only get to see this key once.</p>\n</li>\n<li>\n<p>Setup your repository in Travis (at <a href=\"https://travis-ci.org/\">https://travis-ci.org/</a>)\nI also suggest limiting concurrent builds to 1 in the repo's Travis settings so that builds run sequentially.</p>\n</li>\n<li>\n<p><code>npm install -g travis-encrypt</code> (<a href=\"https://www.npmjs.com/package/travis-encrypt\">https://www.npmjs.com/package/travis-encrypt</a>)</p>\n</li>\n<li>\n<p><code>travis-encrypt -r [repository slug] GITHUB_TOKEN=[personal access token]</code> Note: The repository slug includes your username.</p>\n</li>\n</ol>\n<ol start=\"5\">\n<li>Then setup your .travis.yml file, you need to changes the <code>GITHUB_REPO</code> and <code>secure</code> options.</li>\n</ol>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">language:</span> node_js\n<span class=\"hljs-attr\">node_js:</span>\n<span class=\"hljs-bullet\">  -</span> <span class=\"hljs-string\">\"6.9\"</span>\n<span class=\"hljs-attr\">sudo:</span> <span class=\"hljs-literal\">false</span>\n<span class=\"hljs-attr\">branches:</span>\n<span class=\"hljs-attr\">  only:</span>\n<span class=\"hljs-bullet\">    -</span> master\n<span class=\"hljs-attr\">install:</span>\n<span class=\"hljs-bullet\">-</span> npm install\n<span class=\"hljs-attr\">script:</span>\n<span class=\"hljs-bullet\">-</span> npm run build\n<span class=\"hljs-attr\">after_success:</span>\n<span class=\"hljs-bullet\">-</span> bash ./travis-deploy.sh\n<span class=\"hljs-attr\">env:</span>\n<span class=\"hljs-attr\">  global:</span>\n<span class=\"hljs-attr\">    - GITHUB_REPO:</span> [repository slug]\n<span class=\"hljs-attr\">    - secure:</span> [result from travis-encrypt command]</code></pre>\n<ol start=\"6\">\n<li>And include the travis-deploy script:</li>\n</ol>\n<pre><code class=\"hljs language-sh\"><span class=\"hljs-meta\">#!/bin/bash</span>\n<span class=\"hljs-built_in\">set</span> -o errexit\n\n<span class=\"hljs-comment\"># Info.</span>\n<span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"Running deploy script\"</span>\n<span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"Branch: <span class=\"hljs-variable\">$TRAVIS_BRANCH</span>\"</span>\n<span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"Is a Pull Request: <span class=\"hljs-variable\">$TRAVIS_PULL_REQUEST</span>\"</span>\n\n<span class=\"hljs-comment\"># Exit if the branch is not the master branch.</span>\n<span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$TRAVIS_BRANCH</span>\"</span> != <span class=\"hljs-string\">\"master\"</span> ]\n<span class=\"hljs-keyword\">then</span>\n  <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"This commit was made against the <span class=\"hljs-variable\">$TRAVIS_BRANCH</span> and not the master. No deploy.\"</span>\n  <span class=\"hljs-built_in\">exit</span> 0\n<span class=\"hljs-keyword\">fi</span>\n\n<span class=\"hljs-comment\"># Exit if the commit is a pull request.</span>\n<span class=\"hljs-comment\"># We only want to build / deploy when pull requests are merged into master.</span>\n<span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$TRAVIS_PULL_REQUEST</span>\"</span> != <span class=\"hljs-string\">\"false\"</span> ]\n<span class=\"hljs-keyword\">then</span>\n  <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"This commit is a pull request. No deploy.\"</span>\n  <span class=\"hljs-built_in\">exit</span> 0\n<span class=\"hljs-keyword\">fi</span>\n\n<span class=\"hljs-comment\"># Git config.</span>\ngit config --global user.email <span class=\"hljs-string\">\"nobody@nobody.org\"</span>\ngit config --global user.name <span class=\"hljs-string\">\"Travis CI\"</span>\n\n<span class=\"hljs-comment\"># Build steps (taken care of beforehand)</span>\n\n<span class=\"hljs-comment\"># Deploy.</span>\n<span class=\"hljs-built_in\">cd</span> build\ngit init\ngit add .\ngit commit -m <span class=\"hljs-string\">\"Deploy to Github Pages\"</span>\ngit push --force --quiet <span class=\"hljs-string\">\"https://<span class=\"hljs-variable\">${GITHUB_TOKEN}</span>@github.com/<span class=\"hljs-variable\">${GITHUB_REPO}</span>.git\"</span> master:gh-pages > /dev/null 2>&#x26;1</code></pre>\n<ol start=\"7\">\n<li>Also, make the <code>gh-pages</code> branch on github before running the above script from travis-ci just to be safe.</li>\n</ol>\n<p>This will deploy to the gh-pages branch on any commits into master as long as the build finishes successfully [even if not done through a pull request in case of emergencies ;)]. On pull requests, travis will still try and build the branch to make sure that succeeds, but it won't push any of the changes to gh-pages branch.</p>\n<p>See this in action in the github repo for this blog at  <a href=\"https://github.com/tscanlin/blog.timscanlin.net\">https://github.com/tscanlin/blog.timscanlin.net</a></p>\n","__filename":"posts/2016/automated-deploys-with-travis.md","__url":"/posts/2016/automated-deploys-with-travis/","__resourceUrl":"/posts/2016/automated-deploys-with-travis/index.html","__dataUrl":"/posts/2016/automated-deploys-with-travis/index.html.789bb3ec8691a1a3ba3bc05b6b8f1240.json"}